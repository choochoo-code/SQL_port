<!DOCTYPE html>
<html>
<head>
    <title>Merge CSV to SQL</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">&larr; Back to Home</a>
        <h1>Merge Option CSV Files into SQL</h1>

        <form action="/merge_data" method="POST" enctype="multipart/form-data" id="mergeForm">
            <div class="form-group">
                <label for="schema">1. Select Schema:</label>
                <select id="schema" name="schema" required>
                    <option value="">-- Select Schema --</option>
                    {% for schema in schemas %}
                    <option value="{{ schema }}">{{ schema }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>2. Select Target Table:</label>
                <div class="checkbox-group" id="tableCheckboxes">
                    <div class="checkbox-item disabled">
                        <span class="table-info">
                            <span class="table-name">-- Select Schema First --</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="csv_files">3. Upload CSV Files:</label>
                <input type="file" name="csv_files" id="csv_files" multiple accept=".csv" required>
            </div>

            <button type="submit" id="submitBtn" disabled>Upload and Merge</button>
        </form>
    </div>

    <script>
        let selectedTable = null;

        document.getElementById('schema').addEventListener('change', function() {
            const schema = this.value;
            const checkboxContainer = document.getElementById('tableCheckboxes');
            const submitBtn = document.getElementById('submitBtn');

            selectedTable = null;
            submitBtn.disabled = true;

            if (!schema) {
                checkboxContainer.innerHTML = `
                    <div class="checkbox-item disabled">
                        <span class="table-info">
                            <span class="table-name">-- Select Schema First --</span>
                        </span>
                    </div>
                `;
                return;
            }

            // Show loading
            checkboxContainer.innerHTML = `
                <div class="checkbox-item disabled">
                    <span class="table-info">
                        <span class="table-name">Loading tables...</span>
                    </span>
                </div>
            `;

            // Fetch base tables status
            fetch(`/api/base_tables/${schema}`)
                .then(response => response.json())
                .then(tables => {
                    checkboxContainer.innerHTML = '';

                    Object.entries(tables).forEach(([tableName, info]) => {
                        const div = document.createElement('div');
                        div.className = 'checkbox-item' + (info.exists ? ' exists' : '');
                        div.dataset.table = tableName;

                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'table';
                        radio.value = tableName;
                        radio.id = 'table_' + tableName;

                        const labelDiv = document.createElement('div');
                        labelDiv.className = 'table-info';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'table-name';
                        nameSpan.textContent = info.display;

                        const statusSpan = document.createElement('span');
                        statusSpan.className = 'table-status ' + (info.exists ? 'status-exists' : 'status-new');
                        statusSpan.textContent = info.exists
                            ? '(Table exists - will append data)'
                            : '(Table will be created)';

                        labelDiv.appendChild(nameSpan);
                        labelDiv.appendChild(document.createElement('br'));
                        labelDiv.appendChild(statusSpan);

                        div.appendChild(radio);
                        div.appendChild(labelDiv);

                        // Click handler for the whole row
                        div.addEventListener('click', function(e) {
                            if (e.target !== radio) {
                                radio.checked = true;
                            }
                            selectedTable = tableName;
                            submitBtn.disabled = false;

                            // Update visual selection
                            document.querySelectorAll('.checkbox-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            div.classList.add('selected');
                        });

                        checkboxContainer.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error fetching tables:', error);
                    checkboxContainer.innerHTML = `
                        <div class="checkbox-item disabled">
                            <span class="table-info">
                                <span class="table-name" style="color: red;">Error loading tables</span>
                            </span>
                        </div>
                    `;
                });
        });

        // Form validation
        document.getElementById('mergeForm').addEventListener('submit', function(e) {
            if (!selectedTable) {
                e.preventDefault();
                alert('Please select a target table');
                return false;
            }

            const files = document.getElementById('csv_files').files;
            if (files.length === 0) {
                e.preventDefault();
                alert('Please select at least one CSV file');
                return false;
            }
        });
    </script>

    <style>
        .checkbox-item.selected {
            border-color: #4CAF50;
            background-color: #e8f5e9;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
    </style>
</body>
</html>
